<!DOCTYPE html>
<!--suppress ALL -->
<html>
<head>
	<meta charset="utf-8">
	<meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
	<title>Chatting place {{ room }}</title>
	<link href="../static/bootstrap/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="../static/bootstrap/fonts/font-awesome.min.css" rel="stylesheet">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js" type="text/javascript"></script>
<style>
.message-area {
       height: 25rem;
   overflow-y: scroll;
   overflow-x: hidden;
}
.messages-box {
       height: 25rem;
}
.container{
justify-content: space-between;
align-content: space-between;
}
.flex {
display: flex;
flex-wrap: wrap;
}
.center-item {
margin: 0;
position: absolute;
top: 50%;
left: 50%;
-ms-transform: translate(-50%, -50%);
transform: translate(-50%, -50%);
}
</style>

    {% block javascript %}
        <script charset="utf-8" type="text/javascript">
    var curr_room = ""
    var local_user = null

    function get_form() {
        var js = $("form").serializeArray()
        $.ajax({
            type: "POST",
            contentType: "application/json; charset=utf-8",
            url: "/create_chat/create_chat",
            data: JSON.stringify(js),
            success: function (data) {
                if (data.status === 'OK'){
                    window.location.assign('/chat');
                }
                else
                    window.alert("Error creating chat");
                    window.location.assign('/chat');
            },
            dataType: "json"
            })
    }

    function add_users(){
    fetch('/chat/get_users')
      .then(function (response) {
          return response.json();
      }).then(function (text) {
          var tbody = "";
          for (let value in text) {
              tbody += `<tr>
                        <td class="text-center"><input type="checkbox" name="${value}" id="${value}"/></td>
                        <td>${text[value]['name']}</td>
                        <td>${text[value]['course']}</td>
                        </tr>`;
          }
          tbody += "";
          document.getElementById("tbody_users").innerHTML = tbody;
      });
    }

    function search_table() {
        var input, filter, table, tr, td, i, txtValue;
        input = document.getElementById("user_search_input");
        filter = input.value.toUpperCase();
        table = document.getElementById("user_table");
        tr = table.getElementsByTagName("tr");
        for (i = 0; i < tr.length; i++) {
            td = tr[i].getElementsByTagName("td")[1];
              if (td) {
                txtValue = td.textContent || td.innerText;
              if (txtValue.toUpperCase().indexOf(filter) > -1) {
                tr[i].style.display = "";
              }
              else {
                tr[i].style.display = "none";
              }
            }
        }
        }

    function get_time(){
        var today = new Date();
           var date = (today.toLocaleString('default', { month: 'short' }))+' '+today.getDate();
           var time = today.getHours() + ":" + today.getMinutes() + ":" + today.getSeconds();
        return time + ' | ' + date
    }


    //Send message on enter press
    $(document).on("keypress", "input", function(e){
    if(e.which === 13){
        var inputVal = $(this).val();
        send_message(curr_room)
    }
    });

        $(document).ready(function(){
           socket = io.connect('ws://' + location.host  +'/chat', {secure:true});
           socket.on('connect', function() {
               socket.emit('joined', {'name':local_user, 'time':get_time()});
           });

           socket.on('status', function(data) {
               if (local_user === null){
                local_user = data.name
               }
               var chat_loc = $('#'+data.room_id+'chat');
               $(chat_loc).append('<div class="alert alert-'+data.color +' d-inline-block" role="alert"><h6 class="alert-heading"><strong>'+data.name+'</strong> '+data.msg+'</h6><span>'+ get_time()+'</span></div>')
           });

           socket.on('internal_msg', function(data) {
               //Were last message in conversation
               var msg_loc = $('#'+data.room_id+'chat');
               //Location to scroll to the bottom
               var scroll_loc = document.getElementById(data.room_id+'message-area');
               //Update most recent conversations message and time
               document.getElementById(data.room_id+'last').innerHTML = data.msg
               document.getElementById(data.room_id+'time').innerHTML = get_time()

               // Check if message is from user and append it
               if (data.name === local_user){
               $(msg_loc).append('<div class="row justify-content-end">\n' +
                   '                        <div class="col-md-10">\n' +
                   '                            <div class="media w-50 mb-5" style="width: 60%;">\n' +
                   '                                <div class="media-body ml-3">\n' +
                   '                                   <div class="bg-primary rounded py-2 px-3 mb-2">\n' +
                   '                                    <p class="text-small mb-0 text-white">'+data.msg+'<\/p>\n' +
                   '                             <\/div>\n' +
                   '                             <p class="small text-muted">'+get_time()+'<\/p>\n' +
                   '                                <\/div>\n' +
                   '                            <\/div>\n' +
                   '                        <\/div>\n' +
                   '                    <\/div>')
                scroll_loc.scrollTop = scroll_loc.scrollHeight;
                }
                else {
                $(msg_loc).append('\t\t<div class="media w-50 mb-3">\n' +
                       '\t\t\t<img alt="user" class="rounded-circle" src="'+data.user_image+' "width="50">\n' +
                       '\t\t\t<div class="media-body ml-3">\n' +
                       '\t\t\t\t<div class="bg-light rounded py-2 px-3 mb-2">\n' +
                       '\t\t\t\t\t<p class="text-small mb-0 text-muted">'+data.msg+'</p>\n' +
                       '\t\t\t\t</div>\n' +
                       '\t\t\t\t<p class="small text-muted">'+get_time()+'</p>\n' +
                       '\t\t\t</div>\n' +
                       '\t\t</div>')
                scroll_loc.scrollTop = scroll_loc.scrollHeight;
            }
            });

           // Upade message id to the current tab to send to the correct room
           $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
               //Check currently joined chat
               var currId = $(e.target).attr("id");
                curr_room = currId

                //Scroll to bottom when tab clicked
               var scroll_loc = document.getElementById(currId+'message-area');
               scroll_loc.scrollTop = scroll_loc.scrollHeight;
        })
       });

       function send_message(but_id){
           text = $('#text'+but_id).val();
           $('#text'+but_id).val('');
           socket.emit('text', {msg: text, time:get_time(), name:local_user, room_id:but_id});
       }

       function leave_room(room_id) {
           socket.emit('exit_room', {msg: "Room exit request", time:get_time(), name:local_user, room_id:room_id}, function() {
               console.log("exiting room", room_id)
               window.location.assign('/chat');
           });
       }
        function join_random() {
           socket.emit('join_random', {msg: "Join random request", time:get_time(), name:local_user}, function() {
               window.location.assign('/chat');
           });
       }
	</script>
    {% endblock %}
</head>
<body>

{#Display message as external user#}
{% macro ext_user(msg,time,user_image) %}
		<div class="media w-50 mb-3">
            <img alt="user" class="rounded-circle" src="{{ user_image}}" width="50">
            <div class="media-body ml-3">
                <div class="bg-light rounded py-2 px-3 mb-2">
					<p class="text-small mb-0 text-muted">{{msg}}</p>
                </div>
                <p class="small text-muted">{{time}}</p>
            </div>
        </div>
{% endmacro %}

{#Display message as internal user#}
{% macro int_user(msg,time) %}
		<div class="row justify-content-end">
             <div class="col-md-10">
                 <div class="media w-50 mb-5" style="width: 60%;">
                      <div class="media-body ml-3">
                         <div class="bg-primary rounded py-2 px-3 mb-2">
                             <p class="text-small mb-0 text-white">{{msg}}
                         </div>
                          <p class="small text-muted">{{time}}</p>
                      </div>
                 </div>
              </div>
           </div>
{% endmacro %}

{% macro server_msg(msg,time) %}
<div class="alert alert-info text-center mt-2" role="alert"><h6 class="alert-heading"><strong>{{msg}}</strong> </h6><span>{{ time }}</span></div>
{% endmacro %}

{#Recent tab item showing name, recent message etc#}
{% macro conv(name,time,room,last_msg) %}
		<a class="list-group-item list-group-item-action rounded-0" id="{{room}}" data-toggle="tab" href="#tabChat-{{room}}" role="tab">
		<div class="media">
			<img alt="user" class="rounded-circle" src="https://res.cloudinary.com/mhmd/image/upload/v1564960395/avatar_usae7z.svg" width="50">
			<div class="media-body ml-4">
				<div class="d-flex align-items-center justify-content-between mb-1">
					<h6 class="mb-0">{{name}}</h6><small id="{{ room }}time" class="small font-weight-bold">{{time}}</small>
				</div>
				<p class="font-italic mb-0 text-small" id="{{ room }}last">{{ last_msg }}</p>
			</div>
		</div></a>
{% endmacro %}

{#Content within tab iterates over messages and adds depending on user#}
{% macro tab_cont(msg_dict,room_id) %}
		<div aria-labelledby="home-tab" class="tab-pane" id="tabChat-{{ room_id }}" role="tabpanel">
            <div class="col-md-8">
                <div class="message-area" id="{{ room_id }}message-area">
					<div id="{{ room_id }}chat">
                        {% for item in msg_dict %}
                            {% if name == item['name']%}
                                {{int_user(item['msg'],item['time'])}}
                            {% elif 'server' == item['name']%}
                                {{server_msg(item['msg'],item['time'])}}
                            {% else %}
                                {{ext_user(item['msg'],item['time'],item['user_image'])}}
                            {% endif %}
						{% endfor %}
					</div>
                </div>
                    <small class="form-text text-white">You found the secret sauce</small>
            <div class="row">
                <div class="col-auto">
						<div class="input-group">
                            <label for="text"></label><label for="text{{ room_id }}"></label><input class="shadow-sm form-control form-control-lg" id="text{{ room_id }}" placeholder="Enter message...." type="text">
							<div class="input-group-append">
								<button class="btn btn-primary" id="{{ room_id }}" onclick="send_message(this.id)" type="button"><i class="fa fa-send-o"></i></button>
							</div>
						</div>
					</div>
                <div class="col-auto"><button class="btn btn-outline-danger btn-lg" value="{{ room_id }}" name="exit_butt" onclick="leave_room(this.value)"><i class="fa fa-times"></i> Exit</button></div>
            </div>
            </div>
        </div>
{% endmacro %}

<div class="container">
<div class="row">
    <div class="col-md-4">
        <div class="bg-white">
            <div class="bg-gray px-4 py-2 bg-light">
                <p class="h5 mb-0 py-1">Recent</p>
            </div>
            <div class="messages-box">
                <div class="list-group rounded-0 active" id="myTab" role="tablist">

                  {% for key, value in prev_msg['rooms'].items() %}
                      {% set last_msg = value|last %}
                      {{ conv(last_msg['room_name'],last_msg['time'],key,last_msg['msg']) }}
                  {% endfor %}

                    {% if prev_msg['random_chat']|length > 0 %}
                    {% for key, value in prev_msg['random_chat'].items() %}
                        {% set last_msg = value|last %}
                        {{ conv('Random Chat',last_msg['time'],key,last_msg['msg']) }}
                    {% endfor %}

                {% else %}
                    <div class="center-item">
                        <div class="row no-gutters mt-1">
                            <div class="col text-center">
                                <button class="btn btn-outline-info btn-lg"  onclick="join_random()"><i class="fa fa-users"></i> Random Chat</button>
                            </div>
                        </div>
                    </div>
                {% endif %}

                    <div class="row no-gutters mt-1">
                        <div class="col text-center">
                            <div><a class="btn btn-outline-primary btn-lg" data-toggle="collapse" aria-expanded="false" aria-controls="collapse-1" onclick="add_users()" href="#collapse-1" role="button"><i class="fa fa-comments"></i> New Chat</a>
                                <div class="collapse" id="collapse-1">
                                    <div class="row">
                                        <div class="col-auto col-md-12">
                                            <div class="table-responsive table-bordered">
                                                 <form  onsubmit="get_form()" id="myform" method="post">
                                                     <div class="row text-left no-gutters mt-1">
                                                        <div class="col" style="margin: 1%;">
                                                            <input type="search" class="form-control-sm" id="user_search_input" onkeyup="search_table()" autofocus placeholder="Search User" style="border-top-style: none;border-right-style: none;border-bottom-style: solid;border-bottom-color: var(--blue);border-left-style: none;" />
                                                        </div>
                                                     </div>
                                                        <div class="row no-gutters mt-1">
                                                          <div class="message-area">
                                                            <table class="table table-striped table-bordered table-hover" id="user_table">
                                                                <caption class="text-center">
                                                                    <input type="search" class="form-control-lg" name="chat_name" autofocus placeholder="Chat name..." style="border-top-style: none;border-right-style: none;border-bottom-style: solid;border-bottom-color: var(--blue);border-left-style: none;" required minlength="5" maxlength="15" />
                                                                    <small class="form-text text-white">The hidden surprise</small>
                                                                    <div role="group" class="btn-group btn-group-lg"><button class="btn btn-outline-danger" type="button"><i class="fa fa-close"></i> Clear</button><button class="btn btn-outline-primary" onclick="get_form()" type="button"><i class="fa fa-comments"></i> Create</button></div>
                                                                </caption>
                                                                <thead id="thead_users">
                                                                    <tr>
                                                                        <th class="text-center"><i class="fa fa-plus"></i></th>
                                                                        <th>Name</th>
                                                                        <th>School</th>
                                                                    </tr>
                                                                </thead>

                                                                <tbody id="tbody_users">
                                                                </tbody>
                                                            </table>
                                                          </div>
                                                        </div>
                                                 </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
        <div class="tab-content col-md-8">
            {% for key, value in prev_msg['rooms'].items() %}
                   {{tab_cont(prev_msg['rooms'][key], key)}}
            {% endfor %}

            {% for key, value in prev_msg['random_chat'].items() %}
                   {{tab_cont(prev_msg['random_chat'][key], key)}}
            {% endfor %}
        </div>
    </div>
</div>
<script src="../static/bootstrap/bootstrap/js/bootstrap.min.js"></script>
</body>
</html>