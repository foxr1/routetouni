Index: main.py
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>import os\r\nimport uuid\r\nimport datetime\r\nimport redis\r\nfrom flask import Flask, render_template, session, redirect, url_for, request, send_from_directory\r\nfrom flask_socketio import emit, join_room, leave_room, SocketIO\r\n\r\n# Connect to redis on Docker\r\n# r = redis.Redis(host='localhost', port=6379, charset=\"utf-8\", decode_responses=True)\r\n\r\n# Connect to redis on GCP\r\nfrom forms import LoginForm\r\n\r\nredis_host = os.environ.get('REDISHOST', 'localhost')\r\nredis_port = int(os.environ.get('REDISPORT', 6379))\r\nr = redis.StrictRedis(host=redis_host, port=redis_port, charset=\"utf-8\", decode_responses=True)\r\n\r\nasync_mode = None\r\napp = Flask(__name__)\r\napp.config['SECRET_KEY'] = 'secret!'\r\n\r\nsocketio = SocketIO(app, async_mode=async_mode, logger=True, engineio_logger=True)\r\n\r\n\r\n@app.route('/')\r\ndef index():\r\n    return render_template(\"index.html\")\r\n\r\n\r\n@app.route('/register')\r\ndef register():\r\n    return render_template(\"register.html\")\r\n\r\n\r\n@app.route('/gregister')\r\ndef gregister():\r\n    return render_template(\"google_login.html\")\r\n\r\n\r\n@app.route('/login')\r\ndef login():\r\n    return render_template(\"login.html\")\r\n\r\n\r\n@app.route('/favicon.ico')\r\ndef favicon():\r\n    return send_from_directory(os.path.join(app.root_path, 'static'),\r\n                               'favicon.ico', mimetype='image/vnd.microsoft.icon')\r\n\r\n\r\n@app.route('/news_feed')\r\ndef news_feed():\r\n    return render_template(\"news_feed.html\")\r\n\r\n\r\n@app.route('/chat_index', methods=['GET', 'POST'])\r\ndef chat_index():\r\n    uid = uuid.uuid4()\r\n    session['uid'] = uid\r\n    \"\"\"Login form to enter a room.\"\"\"\r\n    form = LoginForm()\r\n\r\n    if form.validate_on_submit():\r\n        name = form.name.data\r\n        room = form.room.data\r\n\r\n        session['name'] = name\r\n        session['room'] = room\r\n\r\n        return redirect(url_for('.chat'))\r\n    elif request.method == 'GET':\r\n        form.name.data = session.get('name', '')\r\n        form.room.data = session.get('room', '')\r\n    return render_template('chat_index.html', form=form)\r\n\r\n\r\ndef get_messages(room, start, end):\r\n    all_msg = []\r\n    for conv_msg in r.lrange(room, start, end):\r\n        msg = conv_msg.split('&&')\r\n        all_msg.append({'name': msg[1], 'msg': msg[0], 'time': msg[-1]})\r\n    return all_msg\r\n\r\n\r\ndef get_chats():\r\n    print('c')\r\n\r\n\r\n@app.route('/change', methods=['GET', 'POST'])\r\ndef change():\r\n    name = session.get('name', '')\r\n    room = session.get('room', '')\r\n    new_room = request.form.get('room_ch')\r\n    session['room'] = new_room\r\n    return render_template('chat.html', name=name, room=room, prev_msg=get_messages(room, 0, 20))\r\n\r\n\r\n@app.route('/chat')\r\ndef chat():\r\n    name = session.get('name', '')\r\n    room = session.get('room', '')\r\n\r\n    if name == '' or room == '':\r\n        return redirect(url_for('.index'))\r\n    return render_template('chat.html', name=name, room=room, prev_msg=get_messages(room, 0, 20))\r\n\r\n\r\n# When Client Enters\r\n@socketio.on('joined', namespace='/chat')\r\ndef joined(message):\r\n    room = session.get('room')\r\n    \r\n    join_room(20)\r\n    join_room(room)\r\n    emit('status', {'msg': session.get('name') + ' has entered the room', \"id\": 'chat-' + str(room)},\r\n         room=room, prev_msg=get_messages(room, 0, 20))\r\n\r\n\r\n@socketio.on('text', namespace='/chat')\r\ndef text(message):\r\n    room = session.get('room')\r\n    name = session.get('name', '')\r\n\r\n    time = ''.join(message['time'])\r\n\r\n    if r.rpush(room, '%s&&%s&&%s' % (message['msg'], name, time)) > 50:\r\n        r.lpop(room)\r\n\r\n    emit('internal_msg', {'msg': message['msg'], 'id': '#chat-' + str(room), 'name': name}, room=room, name=name)\r\n\r\n\r\n@socketio.on('exit_room', namespace='/chat')\r\ndef exit_room(message):\r\n    room = session.get('room')\r\n    name = session.get('name', '')\r\n    now = datetime.datetime.now().replace(microsecond=0).time()\r\n    leave_msg = name + ' has left the room.'\r\n\r\n    leave_room(room)\r\n    emit('status', {'msg': leave_msg}, room=room)\r\n\r\n\r\nif __name__ == '__main__':\r\n    socketio.run(app, debug=True)\r\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/main.py b/main.py
--- a/main.py	(revision 89c7f5bcea374d2c971ab13895fa322feb7eadef)
+++ b/main.py	(date 1608115350525)
@@ -110,7 +110,7 @@
 def joined(message):
     room = session.get('room')
     
-    join_room(20)
+
     join_room(room)
     emit('status', {'msg': session.get('name') + ' has entered the room', "id": 'chat-' + str(room)},
          room=room, prev_msg=get_messages(room, 0, 20))
Index: templates/chat.html
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+><!DOCTYPE html>\r\n<html>\r\n<head>\r\n\t<meta charset=\"utf-8\">\r\n\t<meta content=\"width=device-width, initial-scale=1.0, shrink-to-fit=no\" name=\"viewport\">\r\n\t<title>Chatting place {{ room }}</title>\r\n\t<link href=\"static/secondstat/bootstrap/css/bootstrap.min.css\" rel=\"stylesheet\">\r\n\t<link href=\"static/secondstat/fonts/font-awesome.min.css\" rel=\"stylesheet\">\r\n\t<link href=\"static/secondstat/css/Bootstrap-Chat.css\" rel=\"stylesheet\">\r\n\t<link href=\"static/secondstat/css/styles.css\" rel=\"stylesheet\">\r\n\t<script src=\"https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js\">\r\n\t</script>\r\n\t<script src=\"//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js\" type=\"text/javascript\">\r\n\t</script>\r\n\t<style>\r\n\r\n\t#message-area {\r\n\t       height: 25rem;\r\n\t   overflow-y: scroll;\r\n\t   overflow-x: hidden;\r\n\t}\r\n\t.messages-box {\r\n\t       height: 25rem;\r\n\t}\r\n\t</style>\r\n\t<script charset=\"utf-8\" type=\"text/javascript\">\r\n\t\t\t\tfunction get_time(){\r\n\t\t\t\t\tvar today = new Date();\r\n\t                   var date = (today.toLocaleString('default', { month: 'short' }))+' '+today.getDate();\r\n\t                   var time = today.getHours() + \":\" + today.getMinutes() + \":\" + today.getSeconds();\r\n\t                   var dateTime = time+ ' | ' +date;\r\n\t                   return dateTime\r\n\t\t\t\t}\r\n\t           $(document).ready(function(){\r\n\t\t\t\t\tvar local_user = $('#my-data').data();\r\n\t               socket = io.connect('wss://' + location.host  + '/chat', {secure:true});\r\n\t               socket.on('connect', function() {\r\n\t                   socket.emit('joined', {'name':local_user.name});\r\n\t               });\r\n\r\n\t               socket.on('status', function(data) {\r\n\t                   var chat_id = data.id\r\n\t                   $('#'+chat_id).val($('#'+chat_id).val()  + data.msg );\r\n\t                   $('#'+chat_id).scrollTop($('#'+chat_id)[0].scrollHeight);\r\n\t               });\r\n\r\n\t               socket.on('internal_msg', function(data) {\r\n\r\n                    var scroll = $('#message-area');\r\n\t               \tif (data.name === local_user.name){\r\n\r\n\r\n\t                   $(data.id).append('<div class=\"row justify-content-end\">\\n' +\r\n\t                       '                        <div class=\"col-md-10\">\\n' +\r\n\t                       '                            <div class=\"media w-50 mb-5\" style=\"width: 60%;\">\\n' +\r\n\t                       '                                <div class=\"media-body ml-3\">\\n' +\r\n\t                       '                                   <div class=\"bg-primary rounded py-2 px-3 mb-2\">\\n' +\r\n\t                       '                                    <p class=\"text-small mb-0 text-white\">'+data.msg+'<\\/p>\\n' +\r\n\t                       '                             <\\/div>\\n' +\r\n\t                       '                             <p class=\"small text-muted\">'+get_time()+'<\\/p>\\n' +\r\n\t                       '                                <\\/div>\\n' +\r\n\t                       '                            <\\/div>\\n' +\r\n\t                       '                        <\\/div>\\n' +\r\n\t                       '                    <\\/div>')\r\n\t                   // $('#chat').val($('#chat').val() + data.msg + '\\n');\r\n                        scroll.scrollTop(scroll.prop(\"scrollHeight\"));\r\n\r\n\t\t\t\t\t\t}else {\r\n\r\n\t\t\t\t\t\t$(data.id).append('\\t\\t<div class=\"media w-50 mb-3\">\\n' +\r\n\t\t\t\t\t\t\t   '\\t\\t\\t<img alt=\"user\" class=\"rounded-circle\" src=\"https://res.cloudinary.com/mhmd/image/upload/v1564960395/avatar_usae7z.svg\" width=\"50\">\\n' +\r\n\t\t\t\t\t\t\t   '\\t\\t\\t<div class=\"media-body ml-3\">\\n' +\r\n\t\t\t\t\t\t\t   '\\t\\t\\t\\t<div class=\"bg-light rounded py-2 px-3 mb-2\">\\n' +\r\n\t\t\t\t\t\t\t   '\\t\\t\\t\\t\\t<p class=\"text-small mb-0 text-muted\">'+data.msg+'</p>\\n' +\r\n\t\t\t\t\t\t\t   '\\t\\t\\t\\t</div>\\n' +\r\n\t\t\t\t\t\t\t   '\\t\\t\\t\\t<p class=\"small text-muted\">'+get_time()+'</p>\\n' +\r\n\t\t\t\t\t\t\t   '\\t\\t\\t</div>\\n' +\r\n\t\t\t\t\t\t\t   '\\t\\t</div>')\r\n\t                   // $('#chat').val($('#chat').val() + data.msg + '\\n');\r\n\t                   {#$(data.id).scrollTop($(data.id)[0].scrollHeight);#}\r\n                        scroll.scrollTop(scroll.prop(\"scrollHeight\"));\r\n\t\t\t\t\t}\r\n\t               \t});\r\n\r\n\r\n\r\n\t               //If enter is pressed send message\r\n\t               $('#text').keypress(function(e) {\r\n\t                   var code = e.keyCode || e.which;\r\n\t                   if (code === 13) {\r\n\t                       send_message()\r\n\t                   }\r\n\t               });\r\n\t           });\r\n\t           function send_message(){\r\n\t               text = $('#text').val();\r\n\t               $('#text').val('');\r\n\t               socket.emit('text', {msg: text, time:get_time()});\r\n\r\n\t           }\r\n\r\n\t           function leave_room() {\r\n\t               socket.emit('exit_room', {}, function() {\r\n\t                   socket.disconnect();\r\n\t                   window.location.href = \"{{ url_for('index') }}\";\r\n\t               });\r\n\t           }\r\n\t</script>\r\n</head>\r\n<body>\r\n\r\n<meta id=\"my-data\" data-name=\"{{name}}\">\r\n\r\n\r\n{% macro ext_user(msg,time) %}\r\n\t\t<div class=\"media w-50 mb-3\">\r\n\t\t\t<img alt=\"user\" class=\"rounded-circle\" src=\"https://res.cloudinary.com/mhmd/image/upload/v1564960395/avatar_usae7z.svg\" width=\"50\">\r\n\t\t\t<div class=\"media-body ml-3\">\r\n\t\t\t\t<div class=\"bg-light rounded py-2 px-3 mb-2\">\r\n\t\t\t\t\t<p class=\"text-small mb-0 text-muted\">{{msg}}</p>\r\n\t\t\t\t</div>\r\n\t\t\t\t<p class=\"small text-muted\">{{time}}</p>\r\n\t\t\t</div>\r\n\t\t</div>\r\n{% endmacro %}\r\n\r\n{% macro int_user(msg,time) %}\r\n\t\t<div class=\"row justify-content-end\">\r\n\t\t\t\t\t\t\t\t <div class=\"col-md-10\">\r\n\t\t\t\t\t\t\t\t\t <div class=\"media w-50 mb-5\" style=\"width: 60%;\">\r\n\t\t\t\t\t\t\t\t\t\t  <div class=\"media-body ml-3\">\r\n\t\t\t\t\t\t\t\t\t\t\t <div class=\"bg-primary rounded py-2 px-3 mb-2\">\r\n\t\t\t\t\t\t\t\t\t\t\t  <p class=\"text-small mb-0 text-white\">{{msg}}\r\n\t\t\t\t\t\t\t\t\t   </div>\r\n\t\t\t\t\t\t\t\t\t\t<p class=\"small text-muted\">{{time}}</p>\r\n\t\t\t\t\t\t\t\t\t\t   </div>\r\n\t\t\t\t\t\t\t\t\t </div>\r\n\t\t\t\t\t\t\t\t  </div>\r\n\t\t\t\t\t\t\t   </div>\r\n{% endmacro %}\r\n\r\n{% macro conv(name,time,room) %}\r\n\t\t<a class=\"list-group-item list-group-item-action rounded-0\" id=\"{{room}}\" data-toggle=\"tab\" href=\"#tabChat-{{room}}\" role=\"tab\">\r\n\t\t<div class=\"media\">\r\n\t\t\t<img alt=\"user\" class=\"rounded-circle\" src=\"https://res.cloudinary.com/mhmd/image/upload/v1564960395/avatar_usae7z.svg\" width=\"50\">\r\n\t\t\t<div class=\"media-body ml-4\">\r\n\t\t\t\t<div class=\"d-flex align-items-center justify-content-between mb-1\">\r\n\t\t\t\t\t<h6 class=\"mb-0\">{{name}}</h6><small class=\"small font-weight-bold\">{{time}}</small>\r\n\t\t\t\t</div>\r\n\t\t\t\t<p class=\"font-italic mb-0 text-small\">this is in the macro</p>\r\n\t\t\t</div>\r\n\t\t</div></a>\r\n{% endmacro %}\r\n\r\n{% macro tab_cont(msg_dict,room_id) %}\r\n\r\n\t\t<div aria-labelledby=\"home-tab\" class=\"tab-pane\" id=\"tabChat-{{ room_id }}\" role=\"tabpanel\">\r\n\t\t\t\t<div class=\"col-md-8\">\r\n                <div class=\"message-area\" id=\"message-area\">\r\n\t\t\t\t\t<div id=\"chat-{{ room_id }}\">\r\n\t\t\t\t\t\t{{ext_user('hi how are you today?','1:38:29 | Dec 14')}}\r\n\t\t\t\t\t\t\t{% for item in msg_dict %}\r\n\t\t\t\t\t\t\t\t{% if name == item['name']%}\r\n\t\t\t\t\t\t\t\t\t{{int_user(item['msg'],item['time'])}}\r\n\t\t\t\t\t\t\t\t{% else %}\r\n\t\t\t\t\t\t\t\t\t{{ext_user(item['msg'],item['time'])}}\r\n\t\t\t\t\t\t\t\t{% endif %}\r\n\t\t\t\t\t\t{% endfor %}\r\n\t\t\t\t\t</div>\r\n                </div>\r\n\r\n                <div class=\"col-xs-1 justify-content-center\">\r\n\t\t\t\t\t\t<div class=\"input-group\" style=\"width: 70%\">\r\n\t\t\t\t\t\t\t<input class=\"shadow-sm form-control form-control-lg\" id=\"{{ room_id }}-text\" placeholder=\"Enter message....\" type=\"text\">\r\n\t\t\t\t\t\t\t<div class=\"input-group-append\">\r\n\t\t\t\t\t\t\t\t<button class=\"btn btn-primary\" onclick=\"send_message()\" type=\"button\"><i class=\"fa fa-send-o\"></i></button>\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</div>\r\n                </div>\r\n\t\t\t</div>\r\n{% endmacro %}\r\n\r\n\t\t<div class=\"container\">\r\n\t\t\t<div class=\"row\">\r\n\t\t\t\t<div class=\"col-md-4\">\r\n\t\t\t\t\t<div class=\"bg-white\">\r\n\t\t\t\t\t\t<div class=\"bg-gray px-4 py-2 bg-light\">\r\n\t\t\t\t\t\t\t<p class=\"h5 mb-0 py-1\">Recent</p>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t<div class=\"messages-box\">\r\n\t\t\t\t\t\t\t<div class=\"list-group rounded-0 active\" id=\"myTab\" role=\"tablist\">\r\n\r\n                                {{ conv(name,'14/232/3333',room) }}\r\n\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\r\n                <div class=\"tab-content col-md-8\">\r\n\t\t\t\t\t\t{{tab_cont(prev_msg, room)}}\r\n\r\n\r\n\r\n\r\n\t\t\t<div aria-labelledby=\"profile-tab\" class=\"tab-pane\" id=\"id\" role=\"tabpanel\">\r\n\t\t\t\tdddd\r\n\t\t\t</div>\r\n\t\t\t<div aria-labelledby=\"messages-tab\" class=\"tab-pane\" id=\"messages\" role=\"tabpanel\">\r\n\t\t\t\t...\r\n\t\t\t</div>\r\n\t\t\t<div aria-labelledby=\"settings-tab\" class=\"tab-pane\" id=\"settings\" role=\"tabpanel\">\r\n\t\t\t\t...\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t\t\t\t<form action=\"/change\" method=\"post\">\r\n\t\t\t\t\t\t\t\t\t  \t\t\t\t\t\t<div class=\"input-group\" style=\"width: 70%; margin: 2%\">\r\n\t\t\t\t\t\t\t<input class=\"shadow-sm form-control form-control-lg\" name=\"room_ch\" id=\"room_ch\" placeholder=\"add room...\" type=\"text\">\r\n\t\t\t\t\t\t\t<div class=\"input-group-append\">\r\n\t\t\t\t\t\t\t\t<button class=\"btn btn-primary\" type=\"submit\"><i class=\"fa fa-send-o\"></i></button>\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t  </form>\r\n\r\n\r\n\t\t\t\t <a href=\"#\" onclick=\"leave_room();\">Leave this room</a>\r\n\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\r\n\r\n\r\n\r\n\r\n\t\t<script>\r\n\t\t$('a[data-toggle=\"tab\"]').on('shown.bs.tab', function (e) {\r\n\t\t  var currId = $(e.target).attr(\"id\");\r\n\r\n\t\t})\r\n\r\n\t\t</script>\r\n\t\t<script src=\"static/secondstat/bootstrap/js/bootstrap.min.js\">\r\n\t\t</script>\r\n\r\n</body>\r\n</html>
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/templates/chat.html b/templates/chat.html
--- a/templates/chat.html	(revision 89c7f5bcea374d2c971ab13895fa322feb7eadef)
+++ b/templates/chat.html	(date 1608115461154)
@@ -33,7 +33,7 @@
 				}
 	           $(document).ready(function(){
 					var local_user = $('#my-data').data();
-	               socket = io.connect('wss://' + location.host  + '/chat', {secure:true});
+	               socket = io.connect('ws://' + location.host  + '/chat', {secure:true});
 	               socket.on('connect', function() {
 	                   socket.emit('joined', {'name':local_user.name});
 	               });
@@ -171,7 +171,7 @@
 
                 <div class="col-xs-1 justify-content-center">
 						<div class="input-group" style="width: 70%">
-							<input class="shadow-sm form-control form-control-lg" id="{{ room_id }}-text" placeholder="Enter message...." type="text">
+							<input class="shadow-sm form-control form-control-lg" id="text" placeholder="Enter message...." type="text">
 							<div class="input-group-append">
 								<button class="btn btn-primary" onclick="send_message()" type="button"><i class="fa fa-send-o"></i></button>
 							</div>
